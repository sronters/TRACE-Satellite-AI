<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TRACE — Tactical Reconnaissance & Analysis of Coastal Environments</title>
  <meta name="description"
    content="TRACE: AI-powered satellite intelligence platform for maritime vessel detection and oil spill monitoring." />
  <link
    href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap"
    rel="stylesheet" />
  <style>
    :root {
      --green: #00ff41;
      --red: #ff003c;
      --amber: #ffb300;
      --bg: #020b05;
      --bg2: #041008;
      --panel: rgba(0, 255, 65, 0.04);
      --border: rgba(0, 255, 65, 0.2);
      --border-red: rgba(255, 0, 60, 0.3);
      --glow: 0 0 20px rgba(0, 255, 65, 0.3);
      --glow-red: 0 0 20px rgba(255, 0, 60, 0.4);
      --text: #c8ffd4;
      --text-dim: #4a7a55;
      --font-mono: 'Share Tech Mono', monospace;
      --font-display: 'Orbitron', sans-serif;
      --font-body: 'Rajdhani', sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-body);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 255, 65, 0.015) 2px, rgba(0, 255, 65, 0.015) 4px),
        repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0, 255, 65, 0.008) 2px, rgba(0, 255, 65, 0.008) 4px);
      pointer-events: none;
      z-index: 0;
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse 80% 60% at 50% 0%, rgba(0, 255, 65, 0.06) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }

    #app {
      position: relative;
      z-index: 1;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 32px;
      border-bottom: 1px solid var(--border);
      background: rgba(2, 11, 5, 0.9);
      backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-icon {
      width: 42px;
      height: 42px;
      border: 2px solid var(--green);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--glow);
      position: relative;
      animation: pulseRing 2.5s ease-in-out infinite;
    }

    .logo-icon::before {
      content: '';
      position: absolute;
      inset: 5px;
      border: 1px solid rgba(0, 255, 65, 0.4);
      border-radius: 50%;
    }

    .logo-icon svg {
      width: 20px;
      height: 20px;
    }

    @keyframes pulseRing {

      0%,
      100% {
        box-shadow: 0 0 12px rgba(0, 255, 65, 0.3), 0 0 24px rgba(0, 255, 65, 0.1);
      }

      50% {
        box-shadow: 0 0 24px rgba(0, 255, 65, 0.6), 0 0 48px rgba(0, 255, 65, 0.2);
      }
    }

    .logo-text h1 {
      font-family: var(--font-display);
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 6px;
      color: var(--green);
      text-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
      line-height: 1;
    }

    .logo-text p {
      font-family: var(--font-mono);
      font-size: 9px;
      color: var(--text-dim);
      letter-spacing: 2px;
      margin-top: 3px;
      text-transform: uppercase;
    }

    .header-status {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 8px var(--green);
      animation: blink 1.5s step-end infinite;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.3;
      }
    }

    .system-time {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-dim);
      letter-spacing: 1px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 320px 1fr 340px;
      gap: 0;
      height: calc(100vh - 73px);
    }

    .panel {
      border-right: 1px solid var(--border);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .panel-right {
      border-right: none;
      border-left: 1px solid var(--border);
    }

    .panel-label {
      font-family: var(--font-mono);
      font-size: 10px;
      letter-spacing: 3px;
      color: var(--text-dim);
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-label::before {
      content: '';
      width: 16px;
      height: 1px;
      background: var(--green);
    }

    .section-title {
      font-family: var(--font-display);
      font-size: 12px;
      letter-spacing: 3px;
      color: var(--green);
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    .mode-toggle {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      overflow: hidden;
      display: flex;
    }

    .mode-btn {
      flex: 1;
      padding: 12px 8px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-family: var(--font-display);
      font-size: 11px;
      letter-spacing: 2px;
      color: var(--text-dim);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .mode-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: transparent;
      transition: background 0.3s;
    }

    .mode-btn.active-optical {
      color: var(--green);
      background: rgba(0, 255, 65, 0.08);
      box-shadow: inset 0 0 20px rgba(0, 255, 65, 0.1);
      text-shadow: 0 0 12px rgba(0, 255, 65, 0.6);
    }

    .mode-btn.active-sar {
      color: var(--red);
      background: rgba(255, 0, 60, 0.08);
      box-shadow: inset 0 0 20px rgba(255, 0, 60, 0.1);
      text-shadow: 0 0 12px rgba(255, 0, 60, 0.6);
    }

    .mode-info {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--panel);
      font-family: var(--font-mono);
      font-size: 11px;
      line-height: 1.6;
    }

    .mode-info.sar {
      border-color: var(--border-red);
      background: rgba(255, 0, 60, 0.04);
    }

    .upload-zone {
      border: 1px dashed var(--border);
      border-radius: 4px;
      padding: 32px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
      background: var(--panel);
    }

    .upload-zone:hover,
    .upload-zone.dragging {
      border-color: var(--green);
      background: rgba(0, 255, 65, 0.06);
      box-shadow: inset 0 0 30px rgba(0, 255, 65, 0.05);
    }

    .upload-zone.sar:hover,
    .upload-zone.sar.dragging {
      border-color: var(--red);
      background: rgba(255, 0, 60, 0.06);
      box-shadow: inset 0 0 30px rgba(255, 0, 60, 0.05);
    }

    .upload-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      border: 1px solid currentColor;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
    }

    .upload-zone:hover .upload-icon {
      color: var(--green);
    }

    .upload-zone.sar:hover .upload-icon {
      color: var(--red);
    }

    .upload-text {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.8;
    }

    #file-input {
      display: none;
    }

    .scan-btn {
      width: 100%;
      padding: 14px;
      background: transparent;
      border: 1px solid var(--green);
      border-radius: 4px;
      color: var(--green);
      font-family: var(--font-display);
      font-size: 13px;
      letter-spacing: 4px;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      position: relative;
      overflow: hidden;
    }

    .scan-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0, 255, 65, 0.15), transparent);
      transition: left 0.4s;
    }

    .scan-btn:hover::before {
      left: 100%;
    }

    .scan-btn:hover {
      background: rgba(0, 255, 65, 0.08);
      box-shadow: var(--glow);
      text-shadow: 0 0 12px rgba(0, 255, 65, 0.6);
    }

    .scan-btn.sar {
      border-color: var(--red);
      color: var(--red);
    }

    .scan-btn.sar::before {
      background: linear-gradient(90deg, transparent, rgba(255, 0, 60, 0.15), transparent);
    }

    .scan-btn.sar:hover {
      background: rgba(255, 0, 60, 0.08);
      box-shadow: var(--glow-red);
      text-shadow: 0 0 12px rgba(255, 0, 60, 0.6);
    }

    .scan-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .center-panel {
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      border-right: none;
      overflow: hidden;
      align-self: start;
    }

    .image-viewport {
      flex: auto;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: #000;
      position: relative;
      overflow: hidden;
      min-height: 200px;
      max-height: 62vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .viewport-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
    }

    .crosshair {
      width: 60px;
      height: 60px;
      position: relative;
      opacity: 0.3;
    }

    .crosshair::before,
    .crosshair::after {
      content: '';
      position: absolute;
      background: var(--green);
    }

    .crosshair::before {
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      transform: translateY(-50%);
    }

    .crosshair::after {
      left: 50%;
      top: 0;
      bottom: 0;
      width: 1px;
      transform: translateX(-50%);
    }

    .crosshair-circle {
      position: absolute;
      inset: 8px;
      border: 1px solid var(--green);
      border-radius: 50%;
    }

    #result-canvas {
      display: none;
      max-width: 100%;
      max-height: 100%;
      width: 100%;
      height: auto;
    }

    #preview-image {
      max-width: 100%;
      max-height: 100%;
      display: none;
      object-fit: contain;
      opacity: 0.5;
    }

    .scanning-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
    }

    .scanning-overlay.active {
      display: flex;
    }

    .scan-bar {
      width: 200px;
      height: 2px;
      background: rgba(0, 255, 65, 0.2);
      border-radius: 1px;
      overflow: hidden;
      position: relative;
    }

    .scan-bar-fill {
      height: 100%;
      width: 0;
      background: var(--green);
      box-shadow: 0 0 8px var(--green);
      animation: scanProgress 3s ease-in-out infinite;
    }

    .scan-bar.sar .scan-bar-fill {
      background: var(--red);
      box-shadow: 0 0 8px var(--red);
    }

    @keyframes scanProgress {
      0% {
        width: 0;
      }

      50% {
        width: 100%;
      }

      100% {
        width: 0;
      }
    }

    .scan-label {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--green);
      letter-spacing: 3px;
      animation: flickerText 0.1s step-end infinite;
    }

    .scan-label.sar {
      color: var(--red);
    }

    @keyframes flickerText {

      0%,
      90%,
      100% {
        opacity: 1;
      }

      95% {
        opacity: 0.8;
      }
    }

    .viewport-corner {
      position: absolute;
      width: 16px;
      height: 16px;
      border-color: var(--green);
      border-style: solid;
      opacity: 0.4;
    }

    .viewport-corner.tl {
      top: 8px;
      left: 8px;
      border-width: 1px 0 0 1px;
    }

    .viewport-corner.tr {
      top: 8px;
      right: 8px;
      border-width: 1px 1px 0 0;
    }

    .viewport-corner.bl {
      bottom: 8px;
      left: 8px;
      border-width: 0 0 1px 1px;
    }

    .viewport-corner.br {
      bottom: 8px;
      right: 8px;
      border-width: 0 1px 1px 0;
    }

    .metrics-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .metric-card {
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 12px;
      background: var(--panel);
      text-align: center;
    }

    .metric-value {
      font-family: var(--font-display);
      font-size: 20px;
      font-weight: 700;
      color: var(--green);
      text-shadow: 0 0 12px rgba(0, 255, 65, 0.4);
      line-height: 1;
    }

    .metric-value.red {
      color: var(--red);
      text-shadow: 0 0 12px rgba(255, 0, 60, 0.4);
    }

    .metric-label {
      font-family: var(--font-mono);
      font-size: 9px;
      color: var(--text-dim);
      letter-spacing: 2px;
      margin-top: 4px;
      text-transform: uppercase;
    }

    .right-panel {
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--border);
      align-self: start;
      max-height: calc(100vh - 73px);
      overflow-y: auto;
    }

    .right-section {
      flex: 0 0 auto;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .right-section:last-child {
      border-bottom: none;
    }

    .detection-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 260px;
      overflow-y: auto;
    }

    .detection-list::-webkit-scrollbar {
      width: 4px;
    }

    .detection-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .detection-list::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    .detection-card {
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 10px;
      background: var(--panel);
      transition: border-color 0.2s;
    }

    .detection-card:hover {
      border-color: rgba(0, 255, 65, 0.4);
    }

    .detection-card.experimental {
      border-color: rgba(255, 179, 0, 0.3);
      background: rgba(255, 179, 0, 0.04);
    }

    .detection-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .detection-label {
      font-family: var(--font-display);
      font-size: 11px;
      color: var(--green);
      letter-spacing: 2px;
    }

    .detection-label.experimental {
      color: var(--amber);
    }

    .detection-conf {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-dim);
    }

    .detection-meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
    }

    .meta-item {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-dim);
    }

    .meta-item span {
      color: var(--text);
    }

    .spill-card {
      border: 1px solid var(--border-red);
      border-radius: 4px;
      padding: 12px;
      background: rgba(255, 0, 60, 0.05);
    }

    .spill-title {
      font-family: var(--font-display);
      font-size: 12px;
      color: var(--red);
      letter-spacing: 2px;
      margin-bottom: 8px;
    }

    .spill-details {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .spill-row {
      display: flex;
      justify-content: space-between;
      font-family: var(--font-mono);
      font-size: 11px;
    }

    .spill-row .label {
      color: var(--text-dim);
    }

    .spill-row .val {
      color: var(--red);
    }

    .intel-output {
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 12px;
    }

    .intel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .qwen-badge {
      font-family: var(--font-mono);
      font-size: 9px;
      color: var(--text-dim);
      border: 1px solid var(--border);
      padding: 3px 8px;
      border-radius: 2px;
      letter-spacing: 1px;
    }

    .intel-text {
      overflow-y: auto;
      max-height: 320px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 14px;
      font-family: var(--font-mono);
      font-size: 11px;
      line-height: 1.8;
      color: #9bcfa5;
      white-space: pre-wrap;
      min-height: 160px;
    }

    .intel-text::-webkit-scrollbar {
      width: 4px;
    }

    .intel-text::-webkit-scrollbar-track {
      background: transparent;
    }

    .intel-text::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    .intel-placeholder {
      color: var(--text-dim);
      font-style: italic;
      text-align: center;
      margin-top: 20px;
      opacity: 0.6;
    }

    .qwen-loading {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-dim);
      font-family: var(--font-mono);
      font-size: 11px;
    }

    .dots {
      display: inline-flex;
      gap: 4px;
    }

    .dots span {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--green);
      animation: dotPulse 1.2s ease-in-out infinite;
    }

    .dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes dotPulse {

      0%,
      80%,
      100% {
        opacity: 0.3;
        transform: scale(0.8);
      }

      40% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .warning-banner {
      padding: 8px 12px;
      border: 1px solid rgba(255, 179, 0, 0.3);
      border-radius: 4px;
      background: rgba(255, 179, 0, 0.05);
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--amber);
      display: none;
      flex-shrink: 0;
    }

    .warning-banner.visible {
      display: block;
    }

    .empty-state {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
      text-align: center;
      padding: 20px;
      opacity: 0.6;
    }

    .sar-inactive-banner {
      padding: 8px 12px;
      border: 1px solid rgba(0, 255, 65, 0.15);
      border-radius: 4px;
      background: rgba(0, 255, 65, 0.03);
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-dim);
      display: none;
    }

    .sar-inactive-banner.visible {
      display: block;
    }

    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: 280px 1fr 300px;
      }
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }

      .panel {
        border-right: none;
        border-bottom: 1px solid var(--border);
      }

      .right-panel {
        border-left: none;
        border-top: 1px solid var(--border);
      }

      .metrics-row {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>

<body>
  <div id="app">
    <header>
      <div class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="#00ff41" stroke-width="1.5">
            <circle cx="12" cy="12" r="3" />
            <path d="M12 2v4M12 18v4M2 12h4M18 12h4" />
            <path d="M5.6 5.6l2.8 2.8M15.6 15.6l2.8 2.8M5.6 18.4l2.8-2.8M15.6 8.4l2.8-2.8" />
          </svg>
        </div>
        <div class="logo-text">
          <h1>TRACE</h1>
          <p>Tactical Reconnaissance & Analysis of Coastal Environments</p>
        </div>
      </div>
      <div class="header-status">
        <div class="status-indicator">
          <div class="status-dot" id="system-dot"></div>
          <span id="system-status">SYSTEM ONLINE</span>
        </div>
        <div class="system-time" id="clock">--:--:-- UTC</div>
      </div>
    </header>

    <div class="main-grid">
      <div class="panel">
        <div class="panel-label">SENSOR MODE</div>

        <div>
          <div class="section-title">Analysis Mode</div>
          <div class="mode-toggle">
            <button class="mode-btn active-optical" id="btn-optical" onclick="setMode('optical')">
              ◉ OPTICAL
            </button>
            <button class="mode-btn" id="btn-sar" onclick="setMode('sar')">
              ◎ SAR RADAR
            </button>
          </div>
          <div class="mode-info" id="mode-info" style="margin-top:10px;">
            <span style="color:var(--green)">▸ OPTICAL MODE</span><br />
            YOLOv8 vessel detection active.<br />
            U-Net oil spill: <span style="color:var(--text-dim)">INACTIVE</span>
          </div>
        </div>

        <div>
          <div class="section-title">Image Upload</div>
          <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()"
            ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
            <div class="upload-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12" />
              </svg>
            </div>
            <div class="upload-text">
              DROP SAT IMAGE HERE<br />
              <span style="font-size:10px;opacity:0.5">PNG · JPG · TIF · GEOTIFF</span>
            </div>
          </div>
          <input type="file" id="file-input" accept="image/*" onchange="handleFileSelect(event)" />
        </div>

        <div>
          <div class="section-title">Execute Scan</div>
          <div class="sar-inactive-banner" id="sar-inactive-banner">
            ⚠ SAR-segmentation is inactive for optical data
          </div>
          <button class="scan-btn" id="scan-btn" onclick="runAnalysis()" disabled>
            ▶ INITIATE SCAN
          </button>
        </div>

        <div style="flex:1;"></div>

        <div style="border-top:1px solid var(--border);padding-top:16px;">
          <div class="panel-label" style="margin-bottom:8px;">SYSTEM STATUS</div>
          <div id="backend-health" class="mode-info" style="font-size:10px;color:var(--text-dim);">
            Checking backend connection...
          </div>
        </div>
      </div>

      <div class="center-panel">
        <div class="panel-label">SATELLITE IMAGERY VIEWPORT</div>
        <div class="image-viewport" id="image-viewport">
          <div class="viewport-corner tl"></div>
          <div class="viewport-corner tr"></div>
          <div class="viewport-corner bl"></div>
          <div class="viewport-corner br"></div>

          <div class="viewport-overlay" id="viewport-placeholder">
            <div class="crosshair">
              <div class="crosshair-circle"></div>
            </div>
            <span style="font-family:var(--font-mono);font-size:11px;color:var(--text-dim);letter-spacing:3px;">AWAITING
              IMAGERY</span>
          </div>

          <img id="preview-image" alt="preview" />
          <canvas id="result-canvas"></canvas>

          <div class="scanning-overlay" id="scanning-overlay">
            <div class="scan-label" id="scan-label">SCANNING...</div>
            <div class="scan-bar" id="scan-bar">
              <div class="scan-bar-fill"></div>
            </div>
            <span style="font-family:var(--font-mono);font-size:10px;color:var(--text-dim);letter-spacing:2px;">AI
              INFERENCE ACTIVE</span>
          </div>
        </div>

        <div class="metrics-row">
          <div class="metric-card">
            <div class="metric-value" id="metric-vessels">—</div>
            <div class="metric-label">Vessels</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="metric-confidence">—</div>
            <div class="metric-label">Avg Conf</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="metric-area">—</div>
            <div class="metric-label">Spill m²</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="metric-mode">OPT</div>
            <div class="metric-label">Mode</div>
          </div>
        </div>
      </div>

      <div class="right-panel">
        <div class="right-section">
          <div class="section-title">Detection Results</div>
          <div class="warning-banner" id="exp-warning">
            ⚠ DOMAIN SHIFT · YOLO EXPERIMENTAL ON SAR DATA
          </div>
          <div class="detection-list" id="detection-list">
            <div class="empty-state">No detections yet.<br />Upload and scan an image.</div>
          </div>
          <div id="spill-card-container" style="margin-top:10px;"></div>
        </div>

        <div class="intel-output">
          <div class="intel-header">
            <div class="section-title" style="margin-bottom:0;">TACTICAL INTEL</div>
            <div class="qwen-badge">QWEN 2.5-VL · BACKEND PROXY</div>
          </div>
          <div class="intel-text" id="intel-text">
            <div class="intel-placeholder">Strategic intelligence report will appear here after scan analysis.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = 'http://localhost:8000';
    let currentMode = 'optical';
    let currentFile = null;

    function updateClock() {
      const now = new Date();
      const h = String(now.getUTCHours()).padStart(2, '0');
      const m = String(now.getUTCMinutes()).padStart(2, '0');
      const s = String(now.getUTCSeconds()).padStart(2, '0');
      document.getElementById('clock').textContent = `${h}:${m}:${s} UTC`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    async function checkHealth() {
      const el = document.getElementById('backend-health');
      try {
        const r = await fetch(`${API}/health`);
        const d = await r.json();
        el.innerHTML = `
      <span style="color:var(--green)">▸ BACKEND ONLINE</span><br/>
      YOLO: <span style="color:${d.yolo_loaded ? 'var(--green)' : 'var(--red)'}">${d.yolo_loaded ? 'LOADED' : 'NOT FOUND'}</span><br/>
      U-Net: <span style="color:${d.unet_loaded ? 'var(--red)' : 'var(--text-dim)'}">${d.unet_loaded ? 'LOADED' : 'NOT FOUND'}</span><br/>
      Device: <span style="color:var(--green)">${d.device.toUpperCase()}</span>
    `;
      } catch (e) {
        el.innerHTML = `<span style="color:var(--red)">▸ BACKEND OFFLINE</span><br/>Start uvicorn: uvicorn app:app --reload`;
        document.getElementById('system-dot').style.background = 'var(--red)';
        document.getElementById('system-dot').style.boxShadow = '0 0 8px var(--red)';
        document.getElementById('system-status').textContent = 'BACKEND OFFLINE';
      }
    }
    checkHealth();

    function setMode(mode) {
      currentMode = mode;
      const btnOpt = document.getElementById('btn-optical');
      const btnSar = document.getElementById('btn-sar');
      const modeInfo = document.getElementById('mode-info');
      const uploadZone = document.getElementById('upload-zone');
      const scanBtn = document.getElementById('scan-btn');
      const sarBanner = document.getElementById('sar-inactive-banner');
      const metricMode = document.getElementById('metric-mode');
      const scanOverlay = document.getElementById('scanning-overlay');
      const scanBar = document.getElementById('scan-bar');
      const scanLabel = document.getElementById('scan-label');

      if (mode === 'optical') {
        btnOpt.className = 'mode-btn active-optical';
        btnSar.className = 'mode-btn';
        modeInfo.className = 'mode-info';
        modeInfo.innerHTML = `<span style="color:var(--green)">▸ OPTICAL MODE</span><br/>YOLOv8 vessel detection active.<br/>U-Net oil spill: <span style="color:var(--text-dim)">INACTIVE</span>`;
        uploadZone.className = 'upload-zone';
        scanBtn.className = 'scan-btn';
        sarBanner.className = 'sar-inactive-banner' + (currentFile ? ' visible' : '');
        metricMode.textContent = 'OPT';
        metricMode.className = 'metric-value';
        scanBar.className = 'scan-bar';
        scanLabel.className = 'scan-label';
      } else {
        btnOpt.className = 'mode-btn';
        btnSar.className = 'mode-btn active-sar';
        modeInfo.className = 'mode-info sar';
        modeInfo.innerHTML = `<span style="color:var(--red)">▸ SAR RADAR MODE</span><br/>U-Net oil spill detection active.<br/>YOLO: <span style="color:var(--amber)">EXPERIMENTAL</span>`;
        uploadZone.className = 'upload-zone sar';
        scanBtn.className = 'scan-btn sar';
        sarBanner.className = 'sar-inactive-banner';
        metricMode.textContent = 'SAR';
        metricMode.className = 'metric-value red';
        scanBar.className = 'scan-bar sar';
        scanLabel.className = 'scan-label sar';
      }

      if (currentFile) scanBtn.disabled = false;
    }

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (file) loadFile(file);
    }

    function handleDragOver(e) {
      e.preventDefault();
      document.getElementById('upload-zone').classList.add('dragging');
    }

    function handleDragLeave() {
      document.getElementById('upload-zone').classList.remove('dragging');
    }

    function handleDrop(e) {
      e.preventDefault();
      document.getElementById('upload-zone').classList.remove('dragging');
      const file = e.dataTransfer.files[0];
      if (file) loadFile(file);
    }

    function loadFile(file) {
      currentFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        const preview = document.getElementById('preview-image');
        preview.src = e.target.result;
        preview.style.display = 'block';
        document.getElementById('viewport-placeholder').style.display = 'none';
        document.getElementById('result-canvas').style.display = 'none';
        document.getElementById('scan-btn').disabled = false;

        if (currentMode === 'optical') {
          document.getElementById('sar-inactive-banner').classList.add('visible');
        }
      };
      reader.readAsDataURL(file);
    }

    async function runAnalysis() {
      if (!currentFile) return;

      document.getElementById('scanning-overlay').classList.add('active');
      document.getElementById('scan-btn').disabled = true;
      document.getElementById('intel-text').innerHTML = '';

      const fd = new FormData();
      fd.append('file', currentFile);
      fd.append('mode', currentMode);

      let data;
      try {
        const resp = await fetch(`${API}/process`, { method: 'POST', body: fd });
        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.detail || 'Server error');
        }
        data = await resp.json();
      } catch (e) {
        document.getElementById('scanning-overlay').classList.remove('active');
        document.getElementById('scan-btn').disabled = false;
        document.getElementById('intel-text').innerHTML = `<span style="color:var(--red)">ERROR: ${e.message}</span>`;
        return;
      }

      document.getElementById('scanning-overlay').classList.remove('active');
      document.getElementById('scan-btn').disabled = false;

      if (data.processed_image) {
        const preview = document.getElementById('preview-image');
        preview.src = 'data:image/png;base64,' + data.processed_image;
        preview.style.display = 'block';
        preview.style.opacity = '1';
        document.getElementById('result-canvas').style.display = 'none';
      }

      renderDetections(data);
      renderMetrics(data);
      await runQwenAnalysis(data);
    }

    function renderDetections(data) {
      const list = document.getElementById('detection-list');
      const expWarn = document.getElementById('exp-warning');
      const spillContainer = document.getElementById('spill-card-container');

      if (data.sar_warning) {
        expWarn.classList.add('visible');
      } else {
        expWarn.classList.remove('visible');
      }

      if (data.detections && data.detections.length > 0) {
        list.innerHTML = data.detections.map(d => `
      <div class="detection-card ${d.warning ? 'experimental' : ''}">
        <div class="detection-header">
          <span class="detection-label ${d.warning ? 'experimental' : ''}">${d.label}</span>
          <span class="detection-conf">${(d.confidence * 100).toFixed(1)}%</span>
        </div>
        <div class="detection-meta">
          <div class="meta-item">L: <span>${d.length_m}m</span></div>
          <div class="meta-item">W: <span>${d.width_m}m</span></div>
          <div class="meta-item">A: <span>${d.area_m2}m²</span></div>
          <div class="meta-item">GPS: <span>${d.lat},${d.lon}</span></div>
        </div>
        ${d.warning ? `<div style="font-family:var(--font-mono);font-size:9px;color:var(--amber);margin-top:6px;">⚠ ${d.warning}</div>` : ''}
      </div>
    `).join('');
      } else {
        list.innerHTML = '<div class="empty-state">No vessels detected.</div>';
      }

      if (data.spill) {
        const s = data.spill;
        spillContainer.innerHTML = `
      <div class="spill-card">
        <div class="spill-title">⚠ OIL SPILL DETECTION</div>
        <div class="spill-details">
          <div class="spill-row">
            <span class="label">Status:</span>
            <span class="val">${s.spill_detected ? 'CONTAMINATION DETECTED' : 'CLEAR'}</span>
          </div>
          <div class="spill-row">
            <span class="label">Area:</span>
            <span class="val">${s.spill_area_m2.toLocaleString()} m²</span>
          </div>
          <div class="spill-row">
            <span class="label">Polygons:</span>
            <span class="val">${s.polygon_count}</span>
          </div>
        </div>
      </div>
    `;
      } else {
        spillContainer.innerHTML = '';
      }
    }

    function renderMetrics(data) {
      const vessels = data.detections ? data.detections.length : 0;
      document.getElementById('metric-vessels').textContent = vessels;

      if (vessels > 0) {
        const avgConf = data.detections.reduce((s, d) => s + d.confidence, 0) / vessels;
        document.getElementById('metric-confidence').textContent = (avgConf * 100).toFixed(0) + '%';
      } else {
        document.getElementById('metric-confidence').textContent = '—';
      }

      if (data.spill && data.spill.spill_area_m2 > 0) {
        document.getElementById('metric-area').textContent = (data.spill.spill_area_m2 / 1000).toFixed(1) + 'k';
        document.getElementById('metric-area').className = 'metric-value red';
      } else {
        document.getElementById('metric-area').textContent = '—';
        document.getElementById('metric-area').className = 'metric-value';
      }
    }

    async function runQwenAnalysis(data) {
      const intelEl = document.getElementById('intel-text');

      const vesselSummary = data.detections && data.detections.length > 0
        ? data.detections.map(d => `${d.label} (${(d.confidence * 100).toFixed(0)}% conf, ${d.length_m}m x ${d.width_m}m, GPS ${d.lat},${d.lon})`).join('; ')
        : 'no vessels';

      const spillSummary = data.spill
        ? `oil spill: ${data.spill.spill_detected ? data.spill.spill_area_m2 + 'm²' : 'none detected'}`
        : 'no spill data';

      const contextStr = `${vesselSummary}. ${spillSummary}. Analysis mode: ${data.mode.toUpperCase()}. ${data.sar_warning || ''}`;

      intelEl.innerHTML = `<div class="qwen-loading"><div class="dots"><span></span><span></span><span></span></div> QWEN 2.5-VL PROCESSING TACTICAL ANALYSIS...</div>`;

      const fd = new FormData();
      fd.append('file', currentFile);
      fd.append('context', contextStr);

      try {
        const resp = await fetch(`${API}/analyze`, { method: 'POST', body: fd });
        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.detail || 'Qwen API error');
        }
        const result = await resp.json();
        intelEl.textContent = result.report;
      } catch (e) {
        intelEl.innerHTML = `<span style="color:var(--amber)">⚠ QWEN ANALYSIS UNAVAILABLE</span>\n\n${e.message}`;
      }
    }
  </script>
</body>

</html>